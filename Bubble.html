<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Network Geo-Visualization</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js for data visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- SheetJS (xlsx.js) for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Leaflet.js for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #tooltip {
            position: absolute; text-align: left; padding: 10px; font-size: 14px;
            background: #2d3748; color: white; border: 1px solid #4a5568;
            border-radius: 8px; pointer-events: none; opacity: 0;
            transition: opacity 0.3s; max-width: 300px; z-index: 1001; /* Above Leaflet */
        }
        .tooltip-key { font-weight: bold; color: #63b3ed; }
        input[type="file"]::file-selector-button {
            background-color: #4a5568; color: white; border: 1px solid #718096;
            padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover { background-color: #718096; }
        .node-label {
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
            user-select: none; pointer-events: none;
        }
        #map-container { background-color: #1a202c; } /* Dark background before map tiles load */
        .leaflet-container { z-index: 1; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center min-h-screen p-4 sm:p-8">

    <div class="w-full max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-100">Dynamic Network Geo-Topology</h1>
            <p class="text-gray-400 mt-2">Upload an Excel file with a 'Lat-Long' column to visualize nodes on a map.</p>
            <p class="text-xs text-gray-500 mt-1">
                File format: 1st row for mapping, 2nd for headers, 3rd onwards for data.
            </p>
        </div>

        <!-- Controls (Same as before) -->
        <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl mb-8 flex flex-col sm:flex-row items-end justify-center gap-4 sm:gap-6 flex-wrap">
            <div>
                <label for="fileInput" class="block text-sm font-medium text-gray-300 mb-2">1. Upload Excel</label>
                <input type="file" id="fileInput" accept=".xlsx" class="text-sm text-gray-300 file:mr-4">
            </div>
            <div>
                <label for="size-select" class="block text-sm font-medium text-gray-300 mb-2">2. Bubble Size</label>
                <select id="size-select" class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" disabled><option>Upload file</option></select>
            </div>
            <div>
                <label for="color-select" class="block text-sm font-medium text-gray-300 mb-2">3. Bubble Color</label>
                <select id="color-select" class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" disabled><option>Upload file</option></select>
            </div>
            <div class="flex items-end gap-2">
                 <div>
                    <label for="filter-key-select" class="block text-sm font-medium text-gray-300 mb-2">4. Filter</label>
                    <select id="filter-key-select" class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" disabled><option value="">Select Field</option></select>
                </div>
                <div>
                     <label for="filter-value-select" class="block text-sm font-medium text-gray-300 mb-2 invisible">Value</label>
                    <select id="filter-value-select" class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" disabled><option>Select field first</option></select>
                </div>
                <div>
                     <label class="block text-sm font-medium text-gray-300 mb-2 invisible">Action</label>
                    <button id="filter-clear-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition duration-200" disabled>Clear</button>
                </div>
            </div>
        </div>

        <!-- Visualization Container -->
        <div id="vis-wrapper" class="w-full bg-gray-800 rounded-xl shadow-2xl p-2 relative" style="height: 60vh;">
             <div id="map-container" class="w-full h-full rounded-xl"></div>
             <div id="placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500 z-0">
                <p>Map visualization will appear here...</p>
            </div>
        </div>
    </div>

    <!-- Tooltip element -->
    <div id="tooltip"></div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const sizeSelect = document.getElementById('size-select');
        const colorSelect = document.getElementById('color-select');
        const filterKeySelect = document.getElementById('filter-key-select');
        const filterValueSelect = document.getElementById('filter-value-select');
        const filterClearBtn = document.getElementById('filter-clear-btn');
        const placeholder = document.getElementById('placeholder');
        const tooltip = d3.select("#tooltip");

        let rawData = [], filteredData = [];
        let map, svg, nodeElements;

        fileInput.addEventListener('change', handleFile);
        sizeSelect.addEventListener('change', renderVisualization);
        colorSelect.addEventListener('change', renderVisualization);
        filterKeySelect.addEventListener('change', populateFilterValues);
        filterValueSelect.addEventListener('change', applyFilter);
        filterClearBtn.addEventListener('click', clearFilter);

        function initMap() {
            if (map) return;
            map = L.map('map-container').setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            L.svg().addTo(map);
            svg = d3.select("#map-container").select("svg").select("g");
        }
        
        function parseLatLng(latLngStr) {
            if (typeof latLngStr !== 'string' || !latLngStr.includes(',')) return null;
            try {
                let [lat, lng] = latLngStr.split(',').map(s => s.trim());
                lat = lat.toUpperCase();
                lng = lng.toUpperCase();

                let latVal = parseFloat(lat.replace(/[°NWES]/g, ''));
                let lngVal = parseFloat(lng.replace(/[°NWES]/g, ''));

                if (lat.includes('S')) latVal = -latVal;
                if (lng.includes('W')) lngVal = -lngVal;
                
                if(isNaN(latVal) || isNaN(lngVal)) return null;

                return L.latLng(latVal, lngVal);
            } catch (e) {
                console.error("Could not parse Lat-Long:", latLngStr, e);
                return null;
            }
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const dataAsArray = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                if (dataAsArray.length < 3) {
                    placeholder.textContent = 'File format error: Must have 3+ rows.';
                    return;
                }
                
                const mappingRow = dataAsArray[0];
                const headerRow = dataAsArray[1];
                const dataRows = dataAsArray.slice(2);

                const latLngHeader = headerRow.find(h => h.toLowerCase().includes('lat-long'));
                if (!latLngHeader) {
                    placeholder.textContent = "Error: 'Lat-Long' column not found in file.";
                    return;
                }

                const sizeHeaders = [], colorHeaders = [], filterHeaders = [];
                headerRow.forEach((header, index) => {
                    if (!header) return;
                    const mapping = (mappingRow[index] || '').trim().toLowerCase();
                    if (mapping === 'size') sizeHeaders.push(header);
                    if (mapping === 'color') colorHeaders.push(header);
                    if (mapping === 'filter') filterHeaders.push(header);
                });

                rawData = dataRows.map(row => {
                    const rowObject = { latlng: null };
                    headerRow.forEach((header, index) => {
                        if (header) {
                             const value = row[index];
                             if(header === latLngHeader) {
                                 rowObject.latlng = parseLatLng(value);
                             } else {
                                rowObject[header] = isNaN(value) || value === '' ? value : +value;
                             }
                        }
                    });
                    return rowObject;
                }).filter(obj => obj.latlng && Object.keys(obj).length > 1);

                if (rawData.length > 0) {
                    filteredData = [...rawData];
                    placeholder.style.display = 'none';
                    initMap();
                    populateSelectors({ sizeHeaders, colorHeaders, filterHeaders });
                    renderVisualization();
                    
                    const bounds = L.latLngBounds(rawData.map(d => d.latlng));
                    if(bounds.isValid()) map.fitBounds(bounds, {padding: [50, 50]});

                } else {
                    placeholder.style.display = 'flex';
                    placeholder.textContent = 'No valid data with Lat-Long coordinates found.';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function populateSelectors({ sizeHeaders, colorHeaders, filterHeaders }) {
            sizeSelect.innerHTML = '';
            colorSelect.innerHTML = '';
            filterKeySelect.innerHTML = '<option value="">Select Field</option>';
            sizeHeaders.forEach(h => rawData.some(d => typeof d[h] === 'number') && sizeSelect.appendChild(new Option(h, h)));
            colorHeaders.forEach(h => colorSelect.appendChild(new Option(h, h)));
            filterHeaders.forEach(h => filterKeySelect.appendChild(new Option(h, h)));
            [sizeSelect, colorSelect, filterKeySelect, filterClearBtn].forEach(el => el.disabled = false);
            populateFilterValues();
        }

        function populateFilterValues() {
            clearFilter(false); // Clear filter but don't re-render
            const filterKey = filterKeySelect.value;
            const select = filterValueSelect;
            select.innerHTML = '';
            if (!filterKey) {
                select.innerHTML = '<option>Select field first</option>';
                select.disabled = true;
                return;
            }
            const uniqueValues = [...new Set(rawData.map(d => d[filterKey]))].sort((a, b) => (typeof a === 'number' && typeof b === 'number') ? a - b : String(a).localeCompare(String(b)));
            select.innerHTML = '<option value="">-- Select Value --</option>';
            uniqueValues.forEach(v => (v !== null && v !== undefined && v !== '') && select.appendChild(new Option(v, v)));
            select.disabled = false;
        }

        function applyFilter() {
            const filterKey = filterKeySelect.value;
            const filterValue = filterValueSelect.value;
            filteredData = filterValue ? rawData.filter(d => d[filterKey] == filterValue) : [...rawData];
            renderVisualization();
        }

        function clearFilter(doRender = true) {
            filterValueSelect.selectedIndex = 0;
            if (filteredData.length === rawData.length) return;
            filteredData = [...rawData];
            if (doRender) renderVisualization();
        }

        function renderVisualization() {
            if (!filteredData.length || !map) return;
            
            const sizeKey = sizeSelect.value, colorKey = colorSelect.value;
            if (!sizeKey || !colorKey) return;
            
            const sizeDomain = d3.extent(filteredData, d => d[sizeKey] || 0);
            const sizeScale = d3.scaleSqrt().domain(sizeDomain).range([5, 40]);
            
            const colorValues = filteredData.map(d => d[colorKey]);
            const isNumericColor = colorValues.every(v => typeof v === 'number');
            let colorScale;
            if (isNumericColor) {
                const colorDomain = d3.extent(colorValues);
                const interpolator = t => t < 0.5 ? d3.interpolateRgb("green", "yellow")(t * 2) : d3.interpolateRgb("yellow", "red")((t - 0.5) * 2);
                colorScale = d3.scaleSequential(interpolator).domain(colorDomain);
            } else {
                colorScale = d3.scaleOrdinal(d3.schemeTableau10).domain([...new Set(colorValues)]);
            }
            
            nodeElements = svg.selectAll(".node")
                .data(filteredData, d => JSON.stringify(d))
                .join("g")
                .attr("class", "node cursor-pointer")
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut);

            nodeElements.selectAll("circle").remove(); // Clear previous circles
            
            nodeElements.append("circle")
                .attr("r", d => sizeScale(d[sizeKey] || 0) * (map.getZoom() / 5))
                .attr("fill", d => colorScale(d[colorKey]))
                .attr("stroke", "#94a3b8")
                .attr("stroke-width", 2)
                .style("opacity", 0.85);

            
            updatePositions();
            map.on("viewreset zoom", updatePositions);
        }

        function updatePositions() {
            if(!nodeElements) return;
            const currentZoom = map.getZoom();
            nodeElements.attr("transform", d => {
                const point = map.latLngToLayerPoint(d.latlng);
                return `translate(${point.x},${point.y})`;
            });
            const sizeKey = sizeSelect.value;
            const sizeDomain = d3.extent(filteredData, d => d[sizeKey] || 0);
            const sizeScale = d3.scaleSqrt().domain(sizeDomain).range([5, 40]);
            
            nodeElements.selectAll('circle').attr("r", d => sizeScale(d[sizeKey] || 0) * (currentZoom / 5));
        }

        function handleMouseOver(event, d) {
            d3.select(this).select('circle').transition().duration(200).attr("stroke", "#63b3ed").attr("stroke-width", 4);
            tooltip.transition().duration(200).style("opacity", .95);
            let content = '';
            for (const key in d) {
                if (key !== 'latlng') {
                     content += `<p><span class="tooltip-key">${key}:</span> ${d[key]}</p>`;
                }
            }
            tooltip.html(content)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 28) + "px");
        }

        function handleMouseOut() {
            d3.select(this).select('circle').transition().duration(200).attr("stroke", "#94a3b8").attr("stroke-width", 2);
            tooltip.transition().duration(500).style("opacity", 0);
        }
    </script>
</body>
</html>


